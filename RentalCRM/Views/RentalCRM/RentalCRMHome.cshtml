@{
    ViewBag.Title = "Trang chủ";
}

<!--begin::Subheader-->
<div class="subheader py-2 py-lg-6 subheader-solid" id="kt_subheader">
    <div class="container-fluid d-flex align-items-center justify-content-between flex-wrap flex-sm-nowrap">
        <!--begin::Info-->
        <div class="d-flex align-items-center flex-wrap mr-1">
            <!--begin::Page Heading-->
            <div class="d-flex align-items-baseline flex-wrap mr-5">
                <!--begin::Page Title-->
                <h5 class="text-dark font-weight-bold my-1 mr-5">Trang chủ</h5>
                <!--end::Page Title-->
                <!--begin::Breadcrumb-->
                <ul class="breadcrumb breadcrumb-transparent breadcrumb-dot font-weight-bold p-0 my-2 font-size-sm">
                    <li class="breadcrumb-item text-muted">
                        <a href="#!" class="text-muted">Trang chủ</a>
                    </li>
                </ul>
                <!--end::Breadcrumb-->
            </div>
            <!--end::Page Heading-->
        </div>
        <!--end::Info-->
        <!--begin::Toolbar-->
        <!--end::Toolbar-->
    </div>
</div>
<!--end::Subheader-->
<!--begin::Post-->
<div class="d-flex flex-column-fluid">
    <!--begin::Container-->
    <div class="container-fluid">
        <div class="row">
            <div class="col-xl-3">
                <!--begin::Stats Widget 16-->
                <a href="#" class="card card-custom bg-warning bg-hover-state-warning card-stretch gutter-b">
                    <!--begin::Body-->
                    <div class="card-body">
                        <span class="svg-icon svg-icon-white svg-icon-3x ml-n1">
                            <!--begin::Svg Icon | path:assets/media/svg/icons/Shopping/Cart3.svg-->
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <polygon points="0 0 24 0 24 24 0 24" />
                                    <path d="M12,11 C9.790861,11 8,9.209139 8,7 C8,4.790861 9.790861,3 12,3 C14.209139,3 16,4.790861 16,7 C16,9.209139 14.209139,11 12,11 Z" fill="#000000" fill-rule="nonzero" opacity="0.3" />
                                    <path d="M3.00065168,20.1992055 C3.38825852,15.4265159 7.26191235,13 11.9833413,13 C16.7712164,13 20.7048837,15.2931929 20.9979143,20.2 C21.0095879,20.3954741 20.9979143,21 20.2466999,21 C16.541124,21 11.0347247,21 3.72750223,21 C3.47671215,21 2.97953825,20.45918 3.00065168,20.1992055 Z" fill="#000000" fill-rule="nonzero" />
                                </g>
                            </svg>
                            <!--end::Svg Icon-->
                        </span>
                        @*<span class="card-title font-weight-bolder text-dark-75 font-size-h2 mb-0 mt-6 d-block">$5,209</span>
                            <span class="font-weight-bold text-muted font-size-sm">SAP UI Progress</span>*@
                        <div class="text-inverse-warning font-weight-bolder font-size-h2 mb-2 mt-5">@ViewBag.CustomerCount</div>
                        <div class="font-weight-bold text-inverse-warning font-size-sm">Khách hàng</div>
                    </div>
                    <!--end::Body-->
                </a>
                <!--end::Stats Widget 16-->
            </div>
            <div class="col-xl-3">
                <!--begin::Stats Widget 13-->
                <a href="#" class="card card-custom bg-danger bg-hover-state-danger card-stretch gutter-b">
                    <!--begin::Body-->
                    <div class="card-body">
                        <span class="svg-icon svg-icon-white svg-icon-3x ml-n1">
                            <!--begin::Svg Icon | path:assets/media/svg/icons/Shopping/Cart3.svg-->
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <rect x="0" y="0" width="24" height="24" />
                                    <path d="M4,9.67471899 L10.880262,13.6470401 C10.9543486,13.689814 11.0320333,13.7207107 11.1111111,13.740321 L11.1111111,21.4444444 L4.49070127,17.526473 C4.18655139,17.3464765 4,17.0193034 4,16.6658832 L4,9.67471899 Z M20,9.56911707 L20,16.6658832 C20,17.0193034 19.8134486,17.3464765 19.5092987,17.526473 L12.8888889,21.4444444 L12.8888889,13.6728275 C12.9050191,13.6647696 12.9210067,13.6561758 12.9368301,13.6470401 L20,9.56911707 Z" fill="#000000" />
                                    <path d="M4.21611835,7.74669402 C4.30015839,7.64056877 4.40623188,7.55087574 4.5299008,7.48500698 L11.5299008,3.75665466 C11.8237589,3.60013944 12.1762411,3.60013944 12.4700992,3.75665466 L19.4700992,7.48500698 C19.5654307,7.53578262 19.6503066,7.60071528 19.7226939,7.67641889 L12.0479413,12.1074394 C11.9974761,12.1365754 11.9509488,12.1699127 11.9085461,12.2067543 C11.8661433,12.1699127 11.819616,12.1365754 11.7691509,12.1074394 L4.21611835,7.74669402 Z" fill="#000000" opacity="0.3" />
                                </g>
                            </svg>
                            <!--end::Svg Icon-->
                        </span>
                        <div class="text-inverse-danger font-weight-bolder font-size-h2 mb-2 mt-5">@ViewBag.ProductCount</div>
                        <div class="font-weight-bold text-inverse-danger font-size-sm">Sản phẩm</div>
                    </div>
                    <!--end::Body-->
                </a>
                <!--end::Stats Widget 13-->
            </div>
            <div class="col-xl-3">
                <!--begin::Stats Widget 14-->
                <a href="#" class="card card-custom bg-primary bg-hover-state-primary card-stretch gutter-b">
                    <!--begin::Body-->
                    <div class="card-body">
                        <span class="svg-icon svg-icon-white svg-icon-3x ml-n1">
                            <!--begin::Svg Icon | path:assets/media/svg/icons/Layout/Layout-4-blocks.svg-->
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <rect x="0" y="0" width="24" height="24"></rect>
                                    <rect fill="#000000" x="4" y="4" width="7" height="7" rx="1.5"></rect>
                                    <path d="M5.5,13 L9.5,13 C10.3284271,13 11,13.6715729 11,14.5 L11,18.5 C11,19.3284271 10.3284271,20 9.5,20 L5.5,20 C4.67157288,20 4,19.3284271 4,18.5 L4,14.5 C4,13.6715729 4.67157288,13 5.5,13 Z M14.5,4 L18.5,4 C19.3284271,4 20,4.67157288 20,5.5 L20,9.5 C20,10.3284271 19.3284271,11 18.5,11 L14.5,11 C13.6715729,11 13,10.3284271 13,9.5 L13,5.5 C13,4.67157288 13.6715729,4 14.5,4 Z M14.5,13 L18.5,13 C19.3284271,13 20,13.6715729 20,14.5 L20,18.5 C20,19.3284271 19.3284271,20 18.5,20 L14.5,20 C13.6715729,20 13,19.3284271 13,18.5 L13,14.5 C13,13.6715729 13.6715729,13 14.5,13 Z" fill="#000000" opacity="0.3"></path>
                                </g>
                            </svg>
                            <!--end::Svg Icon-->
                        </span>
                        <div class="text-inverse-primary font-weight-bolder font-size-h2 mb-2 mt-5">@ViewBag.BranchCount</div>
                        <div class="font-weight-bold text-inverse-primary font-size-sm">Chi nhánh</div>
                    </div>
                    <!--end::Body-->
                </a>
                <!--end::Stats Widget 14-->
            </div>
            <div class="col-xl-3">
                <!--begin::Stats Widget 15-->
                <a href="#" class="card card-custom bg-success bg-hover-state-success card-stretch gutter-b">
                    <!--begin::Body-->
                    <div class="card-body">
                        <span class="svg-icon svg-icon-white svg-icon-3x ml-n1">
                            <!--begin::Svg Icon | path:assets/media/svg/icons/Media/Equalizer.svg-->
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <rect x="0" y="0" width="24" height="24" />
                                    <path d="M12,4.56204994 L7.76822128,9.6401844 C7.4146572,10.0644613 6.7840925,10.1217854 6.3598156,9.76822128 C5.9355387,9.4146572 5.87821464,8.7840925 6.23177872,8.3598156 L11.2317787,2.3598156 C11.6315738,1.88006147 12.3684262,1.88006147 12.7682213,2.3598156 L17.7682213,8.3598156 C18.1217854,8.7840925 18.0644613,9.4146572 17.6401844,9.76822128 C17.2159075,10.1217854 16.5853428,10.0644613 16.2317787,9.6401844 L12,4.56204994 Z" fill="#000000" fill-rule="nonzero" opacity="0.3" />
                                    <path d="M3.5,9 L20.5,9 C21.0522847,9 21.5,9.44771525 21.5,10 C21.5,10.132026 21.4738562,10.2627452 21.4230769,10.3846154 L17.7692308,19.1538462 C17.3034221,20.271787 16.2111026,21 15,21 L9,21 C7.78889745,21 6.6965779,20.271787 6.23076923,19.1538462 L2.57692308,10.3846154 C2.36450587,9.87481408 2.60558331,9.28934029 3.11538462,9.07692308 C3.23725479,9.02614384 3.36797398,9 3.5,9 Z M12,17 C13.1045695,17 14,16.1045695 14,15 C14,13.8954305 13.1045695,13 12,13 C10.8954305,13 10,13.8954305 10,15 C10,16.1045695 10.8954305,17 12,17 Z" fill="#000000" />
                                </g>
                            </svg>
                            <!--end::Svg Icon-->
                        </span>
                        <div class="text-inverse-success font-weight-bolder font-size-h2 mb-2 mt-5">@ViewBag.OrderCount</div>
                        <div class="font-weight-bold text-inverse-success font-size-sm">Đơn hàng</div>
                    </div>
                    <!--end::Body-->
                </a>
                <!--end::Stats Widget 15-->
            </div>
            <div class="col-sm-8">
                <div class="card card-custom gutter-b">
                    <div class="card-header border-0 py-5">
                        <h2 class="card-title">
                            Đơn hàng mới
                        </h2>
                    </div>
                    <div class="card-body pt-0 pb-3">
                        <div class="table-responsive">
                            <table class="table table-head-custom table-head-bg table-borderless table-vertical-center" id="tableData">
                                <thead>
                                    <tr>
                                        <th>khách hàng</th>
                                        <th>sản phẩm</th>
                                        <th>chi nhánh</th>
                                        <th>thời gian</th>
                                        <th>giá</th>
                                        <th>đã thanh toán</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <div class="card card-custom gutter-b">
                    <div class="card-header border-0 py-5">
                        <h2 class="card-title">
                            Doanh thu trong tuần
                        </h2>
                        <div class="card-toolbar">
                            @*<input type="text" id="daterange1" placeholder="Chọn thời gian" class="form-control form-control-solid w-200px" readonly />*@
                        </div>
                    </div>
                    <div class="card-body pt-0 pb-3">
                        <div id="revenuebytimechart">

                        </div>
                    </div>
                </div>
                <div class="card card-custom gutter-b">
                    <div class="card-header border-0 py-5">
                        <h2 class="card-title">
                            Doanh thu theo chi nhánh
                        </h2>
                        <div class="card-toolbar">
                            @*<input type="text" id="daterange1" placeholder="Chọn thời gian" class="form-control form-control-solid w-200px" readonly />*@
                        </div>
                    </div>
                    <div class="card-body pt-0 pb-3">
                        <div id="revenuebybranchchart">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--end::Container-->
</div>
<!--end::Post-->
<script type="text/javascript">
    var dataSource = [], table, revenuebytimechart, revenuebybranchchart;
    $(function () {
        loadDataForRevenueChartByWeek();
        loadDataForRevenueByBranchChart();
        loadDataForTable();

        //options for area chart
        var options1 = {
            series: [],
            chart: {
                type: 'area',
                height: 250,
                zoom: {
                    enabled: false
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth'
            },
            markers: {
                size: 4,
            },
            yaxis: {
                title: {
                    text: 'vnđ'
                },
            },
            tooltip: {
                y: [
                    {
                        title: {
                            formatter: function () {
                                return ''
                            }
                        },
                        formatter: function (val) {
                            return val.toLocaleString('en-US') + " vnđ"
                        }
                    }
                ]
            },
            noData: {
                text: 'Đang tải dữ liệu...'
            },
            xaxis: {
                type: 'category',
                categories: [],
                tickAmount: 6
            },

        };

        //options for bar chart
        //var options2 = {
        //    series: [],
        //    chart: {
        //        type: 'bar',
        //        height: 250,
        //        zoom: {
        //            enabled: false
        //        }
        //    },
        //    dataLabels: {
        //        enabled: false
        //    },
        //    yaxis: {
        //        title: {
        //            text: 'vnđ'
        //        },
        //    },
        //    plotOptions: {
        //        bar: {
        //            horizontal: false,
        //            borderRadius: 4,
        //        },
        //    },
        //    tooltip: {
        //        y: [
        //            {
        //                title: {
        //                    formatter: function () {
        //                        return ''
        //                    }
        //                },
        //                formatter: function (val) {
        //                    return val.toLocaleString('en-US') + " vnđ"
        //                }
        //            }
        //        ]
        //    },
        //    noData: {
        //        text: 'Đang tải dữ liệu...'
        //    },
        //    xaxis: {
        //        type: 'category',
        //        categories: [],
        //        tickAmount: 6
        //    },

        //}

        var options2 = {
            series: [],
            chart: {
                type: 'bar',
                height: 250
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%',
                    endingShape: 'rounded'
                },
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                show: true,
                width: 2,
                colors: ['transparent']
            },
            xaxis: {
                categories: [],
            },
            yaxis: {
                title: {
                    text: 'vnđ'
                }
            },
            noData: {
                text: 'Đang tải dữ liệu...'
            },
            fill: {
                opacity: 1
            },
            tooltip: {
                y: {
                    formatter: function (val) {
                        return val.toLocaleString('en-US') + " vnđ"
                    }
                }
            }
        };
        revenuebytimechart = new ApexCharts(document.querySelector("#revenuebytimechart"), options1);
        revenuebytimechart.render();

        revenuebybranchchart = new ApexCharts(document.querySelector("#revenuebybranchchart"), options2);
        revenuebybranchchart.render();

        })

    function loadDataForTable() {
        $.ajax({
            url: '@Url.Action("getrecentorder","order")',
            type: "GET",
            contentType: "application/json",
            success: function (response) {
                dataSource = response.data;
                dataSource.forEach(function (item) {
                    var rowTable = `<tr>
                        <td>
                            <a href="#!" class="text-dark-75 font-weight-bolder text-hover-primary mb-1 font-size-lg">${item.customerName}</a>
                            <span class="text-muted font-weight-bold d-block">${item.customerCategoryName}</span>
                        </td>
                        <td>
                            <span class="text-dark-75 font-weight-bolder d-block font-size-lg">${item.productName}</span>
                            <span class="text-muted font-weight-bold d-block">${"Size " + item.productSizeName + " x " + item.quantity}</span>
                        </td>
                        <td>${item.branchName}</td>
                        <td>${item.createdTime + " - " + item.expectedReturnDate}</td>
                        <td>${item.price}</td>
                        <td>${item.advancePayment}</td>
                    </tr>`;
                    $("#tableData tbody").append(rowTable);
                })
            }
        });
    }

    function loadDataForRevenueChartByWeek() {

        //var startDate = moment().subtract(6, 'days').format("YYYY-MM-DD");
        //var endDate = moment().format("YYYY-MM-DD");
        //var rangeData=["22/02","23/02","24/02","25/02","26/02","27/02","28/02"]

        $.ajax({
            /*            url: '/don-hang/api/reportrevenuebytime',*/
            url: '@Url.Action("reportrevenuebytime", "order")',
            type: "GET",
            data: {
                startDate: '2022-02-22',
                endDate: '2022-02-28'
            },
            contentType: "application/json",
            success: function (response) {
                var dataSource = response.data;

                //for (var date of rangeData) {
                //    var data = dataSource.find(function (item) {
                //        return item.categoryName == date;
                //    })
                //    if (!data) {
                //        dataSource.push({ categoryName: date, totalMoney: 0 });
                //    }
                //}
                var series = [];

                var data = dataSource.map(function (item) {
                    return item.totalMoney;
                });
                series.push({
                    name: "",
                    data: data
                })

                var categories = dataSource.map(function (item) {
                    return item.categoryName;
                })

                revenuebytimechart.updateOptions({
                    series: series,
                    xaxis: {
                        type: 'category',
                        categories: categories,
                        tickAmount: 6
                    },
                })
                
            },
            error: function () {
                revenuebytimechart.updateOptions({
                    noData: {
                        text:""
                    }
                })
            }
        });
    }

    function loadDataForRevenueByBranchChart() {

        //var startDate = moment().subtract(6, 'days').format("YYYY-MM-DD");
        //var endDate = moment().format("YYYY-MM-DD");
        //var rangeData = ["22/02", "23/02", "24/02", "25/02", "26/02", "27/02", "28/02"]

        $.ajax({
            /*            url: '/don-hang/api/reportrevenuebybranch',*/
            url: '@Url.Action("reportrevenuebybranch", "order")',
            type: "GET",
            data: {
                startDate: '2022-02-22',
                endDate: '2022-02-28'
            },
            contentType: "application/json",
            success: function (response) {
                var data = response.data;
                //for (var date of rangeData) {
                //    for (var data of dataSource) {
                //        var obj = dataSource.find(function (item) {
                //            return item.categoryName == date;
                //        })
                //        if (!obj) {
                //            dataSource.push({ categoryName: date, totalMoney: 0 });
                //        }
                //    }
                //}
                var series = data.map(function (item) {
                    return {
                        name: item.branchName,
                        data: item.dataSource.map(function (item) {
                            return item.totalMoney
                        })
                    };
                });
                //console.log(series);
                var categories = data[0].dataSource.map(function (item) {
                    return item.category
                })
                //console.log(categories)

                revenuebybranchchart.updateOptions({
                    series: series,
                    xaxis: {
                        categories: categories,
                    }
                })
            },
            error: function () {
                revenuebybranchchart.updateOptions({
                    noData: {
                        text: ""
                    }
                })
            }
        });
    }
</script>
